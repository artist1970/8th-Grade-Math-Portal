<script type="module">
import { getAllStudentsProgress } from './scripts/dataHandler.js';

const studentList = document.getElementById('studentList');
const summaryTableBody = document.querySelector('#summaryTable tbody');
const overviewSection = document.getElementById('overview');
const chartSection = document.getElementById('chartSection');
const insightsSection = document.getElementById('insights');
const insightText = document.getElementById('insightText');
const parentChartCanvas = document.getElementById('parentChart');
let parentChart;

// Load all students from localStorage
const allStudents = getAllStudentsProgress();
const studentNames = Object.keys(allStudents);

studentNames.forEach(name => {
  const option = document.createElement('option');
  option.value = name;
  option.textContent = name;
  studentList.appendChild(option);
});

studentList.addEventListener('change', (e) => {
  const selectedName = e.target.value;
  if (!selectedName) return;

  const progress = allStudents[selectedName] || {};
  renderSummaryTable(progress);
  renderChart(progress);
  renderInsights(progress);
});

function renderSummaryTable(progress) {
  summaryTableBody.innerHTML = '';
  for (const [subject, chapters] of Object.entries(progress)) {
    chapters.forEach(chap => {
      const percentage = chap.total ? Math.round((chap.score / chap.total) * 100) : 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:6px; border-bottom:1px solid #4aa3ff;">${subject}</td>
        <td style="padding:6px; border-bottom:1px solid #4aa3ff;">${chap.name}</td>
        <td style="padding:6px; border-bottom:1px solid #4aa3ff;">${chap.score}</td>
        <td style="padding:6px; border-bottom:1px solid #4aa3ff;">${percentage}%</td>
      `;
      summaryTableBody.appendChild(row);
    });
  }
  overviewSection.style.display = 'block';
}

function renderChart(progress) {
  const subjects = Object.keys(progress);
  const weeklyScores = subjects.map(sub => {
    const chapters = progress[sub];
    return chapters.length
      ? Math.round(chapters.reduce((acc,c) => acc + (c.total ? (c.score / c.total) * 100 : 0), 0)/chapters.length)
      : 0;
  });

  if (parentChart) parentChart.destroy();

  parentChart = new Chart(parentChartCanvas, {
    type: 'bar',
    data: {
      labels: subjects,
      datasets: [{
        label: 'Average % per Subject',
        data: weeklyScores,
        backgroundColor: '#4aa3ff'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });

  chartSection.style.display = 'block';
}

function renderInsights(progress) {
  let insights = '';
  for (const [subject, chapters] of Object.entries(progress)) {
    const avg = chapters.length
      ? Math.round(chapters.reduce((acc,c)=>acc + (c.total ? (c.score / c.total) * 100 : 0),0)/chapters.length)
      : 0;

    if (avg < 60) insights += `⚠️ ${subject}: Student may need extra help. Avg: ${avg}%<br>`;
    else if (avg < 85) insights += `✅ ${subject}: Good progress. Avg: ${avg}%<br>`;
    else insights += `🌟 ${subject}: Excellent work! Avg: ${avg}%<br>`;
  }
  insightText.innerHTML = insights;
  insightsSection.style.display = 'block';
}
</script>
